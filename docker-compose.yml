version: '3.8'

services:
  # Sentinel Proxy
  sentinel:
    build:
      context: ./proxy
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    depends_on:
      - backend-1
      - backend-2
      - backend-3
    networks:
      - sentinel-net

  # Test Backend Services
  backend-1:
    build:
      context: ./simulator
      dockerfile: Dockerfile
    ports:
      - "8081:8080"
    environment:
      - BACKEND_ID=backend-1
      - BACKEND_PORT=8080
      - BASE_LATENCY_MS=50
    networks:
      - sentinel-net

  backend-2:
    build:
      context: ./simulator
      dockerfile: Dockerfile
    ports:
      - "8082:8080"
    environment:
      - BACKEND_ID=backend-2
      - BACKEND_PORT=8080
      - BASE_LATENCY_MS=50
    networks:
      - sentinel-net

  backend-3:
    build:
      context: ./simulator
      dockerfile: Dockerfile
    ports:
      - "8083:8080"
    environment:
      - BACKEND_ID=backend-3
      - BACKEND_PORT=8080
      - BASE_LATENCY_MS=50
    networks:
      - sentinel-net

  # Dashboard
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_SENTINEL_WS=ws://localhost:8080/ws/metrics
      - NEXT_PUBLIC_SENTINEL_API=http://localhost:8080
    depends_on:
      - sentinel
    networks:
      - sentinel-net

networks:
  sentinel-net:
    driver: bridge
